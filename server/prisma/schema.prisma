generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ==================== 用户与认证 ====================

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String

  status       UserStatus @default(ACTIVE)
  role         UserRole   @default(PLAYER)

  lastLoginAt  DateTime?
  lastLoginIp  String?
  loginCount   Int       @default(0)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  player        Player?
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([username])
}

model RefreshToken {
  id         String   @id @default(uuid())
  token      String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceInfo String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([token])
}

enum UserStatus {
  ACTIVE
  BANNED
  SUSPENDED
}

enum UserRole {
  PLAYER
  GM
  ADMIN
}

// ==================== 玩家数据 ====================

model Player {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name             String
  title            String?
  avatarId         Int      @default(1)

  realm            String   @default("炼气")
  realmStage       String   @default("初期")
  cultivation      BigInt   @default(0)
  totalCultivation BigInt   @default(0)

  health           Int      @default(100)
  maxHealth        Int      @default(100)
  attack           Int      @default(10)
  defense          Int      @default(5)
  speed            Int      @default(10)
  critRate         Float    @default(0.05)
  critDamage       Float    @default(1.5)

  spiritualRoot    String

  spiritStones     BigInt   @default(0)
  destinyPoints    Int      @default(0)

  combatPower      BigInt   @default(0)
  pvpRating        Int      @default(1000)
  reincarnations   Int      @default(0)

  vipLevel         Int      @default(0)
  vipExpireAt      DateTime?

  lastActiveAt     DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  gameSaves        GameSave[]
  rankings         Ranking[]
  sentFriendReqs   FriendRequest[] @relation("SentRequests")
  recvFriendReqs   FriendRequest[] @relation("ReceivedRequests")
  friends          Friend[]        @relation("PlayerFriends")
  friendOf         Friend[]        @relation("FriendOfPlayer")
  sectMember       SectMember?
  sentMails        Mail[]          @relation("SentMails")
  receivedMails    Mail[]          @relation("ReceivedMails")
  marketListings   MarketListing[]
  tradeHistory     TradeLog[]
  pvpMatches       PvpMatch[]      @relation("PvpPlayer")
  pvpOpponents     PvpMatch[]      @relation("PvpOpponent")
  activityProgress ActivityProgress[]

  @@index([realm, combatPower])
  @@index([pvpRating])
}

// ==================== 存档系统 ====================

model GameSave {
  id            String   @id @default(uuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  slot          Int      @default(1)
  name          String

  playerData    String
  gameData      String
  alchemyData   String
  discipleData  String
  roguelikeData String

  playTime      Int      @default(0)
  checkpoint    String?

  checksum      String
  version       Int      @default(1)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([playerId, slot])
  @@index([playerId])
}

// ==================== 排行榜 ====================

model Ranking {
  id        String      @id @default(uuid())
  playerId  String
  player    Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)

  type      RankingType
  score     BigInt
  rank      Int?

  snapshot  String

  seasonId  Int?

  updatedAt DateTime @updatedAt

  @@unique([playerId, type, seasonId])
  @@index([type, score])
}

enum RankingType {
  COMBAT_POWER
  REALM
  REINCARNATION
  PVP_RATING
  WEALTH
  SECT
}

// ==================== 好友系统 ====================

model FriendRequest {
  id         String              @id @default(uuid())
  senderId   String
  sender     Player              @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   Player              @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  status     FriendRequestStatus @default(PENDING)
  message    String?

  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@unique([senderId, receiverId])
  @@index([receiverId, status])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Friend {
  id        String   @id @default(uuid())
  playerId  String
  player    Player   @relation("PlayerFriends", fields: [playerId], references: [id], onDelete: Cascade)
  friendId  String
  friend    Player   @relation("FriendOfPlayer", fields: [friendId], references: [id], onDelete: Cascade)

  intimacy  Int      @default(0)
  remark    String?

  createdAt DateTime @default(now())

  @@unique([playerId, friendId])
  @@index([playerId])
}

// ==================== 门派系统 ====================

model Sect {
  id             String       @id @default(uuid())
  name           String       @unique

  description    String?
  notice         String?
  iconId         Int          @default(1)

  level          Int          @default(1)
  experience     BigInt       @default(0)
  fund           BigInt       @default(0)

  joinType       SectJoinType @default(APPROVAL)
  minRealmToJoin String?

  memberCount    Int          @default(1)
  maxMembers     Int          @default(50)
  totalPower     BigInt       @default(0)

  founderId      String

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  members        SectMember[]
  applications   SectApplication[]

  @@index([totalPower])
}

enum SectJoinType {
  OPEN
  APPROVAL
  INVITE_ONLY
}

model SectMember {
  id           String   @id @default(uuid())
  sectId       String
  sect         Sect     @relation(fields: [sectId], references: [id], onDelete: Cascade)
  playerId     String   @unique
  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  role         SectRole @default(MEMBER)
  contribution BigInt   @default(0)

  joinedAt     DateTime @default(now())

  @@index([sectId, contribution])
}

enum SectRole {
  LEADER
  ELDER
  DEACON
  MEMBER
}

model SectApplication {
  id        String   @id @default(uuid())
  sectId    String
  sect      Sect     @relation(fields: [sectId], references: [id], onDelete: Cascade)
  playerId  String

  message   String?
  status    String   @default("PENDING")

  createdAt DateTime @default(now())

  @@unique([sectId, playerId])
}

// ==================== 邮件系统 ====================

model Mail {
  id          String    @id @default(uuid())

  senderId    String?
  sender      Player?   @relation("SentMails", fields: [senderId], references: [id], onDelete: SetNull)

  receiverId  String
  receiver    Player    @relation("ReceivedMails", fields: [receiverId], references: [id], onDelete: Cascade)

  type        MailType  @default(NORMAL)
  title       String
  content     String

  attachments String?

  isRead      Boolean   @default(false)
  isClaimed   Boolean   @default(false)

  expiresAt   DateTime?

  createdAt   DateTime  @default(now())

  @@index([receiverId, isRead])
  @@index([receiverId, createdAt])
}

enum MailType {
  NORMAL
  SYSTEM
  REWARD
  TRADE
}

// ==================== 交易市场 ====================

model MarketListing {
  id        String        @id @default(uuid())
  sellerId  String
  seller    Player        @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  itemType  String
  itemId    String
  itemData  String
  amount    Int           @default(1)

  price     BigInt
  currency  String        @default("spiritStones")

  status    ListingStatus @default(ACTIVE)

  expiresAt DateTime
  createdAt DateTime      @default(now())
  soldAt    DateTime?

  @@index([itemType, status])
  @@index([status, price])
  @@index([sellerId])
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
  EXPIRED
}

model TradeLog {
  id        String   @id @default(uuid())

  sellerId  String?
  buyerId   String
  buyer     Player   @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  listingId String?
  itemType  String
  itemId    String
  itemData  String
  amount    Int

  price     BigInt
  currency  String

  fee       BigInt   @default(0)

  createdAt DateTime @default(now())

  @@index([buyerId, createdAt])
  @@index([sellerId, createdAt])
}

// ==================== PVP系统 ====================

model PvpMatch {
  id         String    @id @default(uuid())

  playerId   String
  player     Player    @relation("PvpPlayer", fields: [playerId], references: [id], onDelete: Cascade)
  opponentId String
  opponent   Player    @relation("PvpOpponent", fields: [opponentId], references: [id], onDelete: Cascade)

  winnerId   String?
  result     PvpResult

  playerRatingChange   Int
  opponentRatingChange Int

  battleLog  String
  duration   Int

  seasonId   Int

  createdAt  DateTime @default(now())

  @@index([playerId, seasonId])
  @@index([seasonId, createdAt])
}

enum PvpResult {
  WIN
  LOSE
  DRAW
}

model PvpSeason {
  id        Int      @id @default(autoincrement())
  name      String

  startAt   DateTime
  endAt     DateTime

  rewards   String

  isActive  Boolean  @default(false)

  createdAt DateTime @default(now())
}

// ==================== 运营系统 ====================

model Announcement {
  id        String   @id @default(uuid())

  title     String
  content   String
  type      String   @default("normal")

  priority  Int      @default(0)
  isActive  Boolean  @default(true)

  startAt   DateTime @default(now())
  endAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, priority])
}

model Activity {
  id          String   @id @default(uuid())

  name        String
  description String
  type        String

  config      String

  startAt     DateTime
  endAt       DateTime

  isActive    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  progress    ActivityProgress[]

  @@index([isActive, startAt])
}

model ActivityProgress {
  id         String   @id @default(uuid())
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  playerId   String
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  progress   String
  rewards    String?

  updatedAt  DateTime @updatedAt

  @@unique([activityId, playerId])
}

// ==================== 聊天记录 ====================

model ChatMessage {
  id          String      @id @default(uuid())

  channel     ChatChannel
  channelId   String?

  senderId    String
  senderName  String
  senderRealm String

  content     String

  createdAt   DateTime    @default(now())

  @@index([channel, channelId, createdAt])
  @@index([createdAt])
}

enum ChatChannel {
  WORLD
  SECT
  PRIVATE
}

// ==================== 操作日志 ====================

model OperationLog {
  id        String   @id @default(uuid())

  userId    String?
  playerId  String?

  action    String
  target    String?
  details   String?

  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// ==================== 物品系统 ====================

model ItemTemplate {
  id          String     @id @default(uuid())
  itemId      String     @unique // 物品唯一标识符

  name        String
  description String
  type        ItemType
  quality     ItemQuality

  stackable   Boolean    @default(true)
  maxStack    Int        @default(99)

  // 消耗品效果 JSON: [{type, value, duration?}]
  effects     String?

  // 售价
  sellPrice   Int        @default(0)
  buyPrice    Int?

  // 图标
  iconId      String?

  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([type, quality])
  @@index([isActive])
}

enum ItemType {
  CONSUMABLE    // 消耗品
  MATERIAL      // 材料
  EQUIPMENT     // 装备
  QUEST         // 任务物品
  CURRENCY      // 货币
}

enum ItemQuality {
  COMMON        // 凡品
  UNCOMMON      // 良品
  RARE          // 精品
  EPIC          // 极品
  LEGENDARY     // 传说
  MYTHIC        // 神话
}

// ==================== 装备系统 ====================

model EquipmentTemplate {
  id              String        @id @default(uuid())
  equipmentId     String        @unique

  name            String
  description     String
  slot            EquipmentSlot
  quality         ItemQuality

  // 基础属性 JSON: {attack?, defense?, maxHp?, maxMp?, speed?, critRate?, critDamage?}
  baseStats       String

  // 附加属性 JSON: [{attribute, value, isPercentage}]
  bonusStats      String?

  // 强化等级
  maxEnhanceLevel Int           @default(10)

  // 需求 JSON: [{type, value}]
  requirements    String?

  // 特殊效果描述
  specialEffect   String?

  sellPrice       Int           @default(0)
  iconId          String?

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([slot, quality])
}

enum EquipmentSlot {
  WEAPON
  ARMOR
  HELMET
  BOOTS
  ACCESSORY
  TALISMAN
}

// ==================== 玩家背包 ====================

model PlayerInventory {
  id        String   @id @default(uuid())
  playerId  String

  itemId    String   // 对应 ItemTemplate.itemId 或 EquipmentTemplate.equipmentId
  itemType  String   // item 或 equipment
  quantity  Int      @default(1)

  // 装备专用: 强化等级、附魔等
  extraData String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, itemId, itemType])
  @@index([playerId])
}

// ==================== 玩家装备栏 ====================

model PlayerEquipment {
  id          String        @id @default(uuid())
  playerId    String        @unique

  weapon      String?       // 装备实例ID
  armor       String?
  helmet      String?
  boots       String?
  accessory   String?
  talisman    String?

  updatedAt   DateTime      @updatedAt
}

// ==================== 剧情系统 ====================

model StoryChapter {
  id          String      @id @default(uuid())
  chapterId   String      @unique // chapter_1, chapter_2...

  name        String
  description String?
  order       Int         // 章节顺序

  // 解锁条件 JSON: [{type, key, operator, value}]
  unlockConditions String?

  // 章节完成奖励 JSON: [{type, itemId?, value?}]
  rewards     String?

  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  nodes       StoryNode[]

  @@index([order])
}

model StoryNode {
  id          String       @id @default(uuid())
  nodeId      String       @unique // chapter_1_node_1

  chapterId   String
  chapter     StoryChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  type        StoryNodeType
  order       Int          // 节点顺序

  // 说话者 (对话类型)
  speaker     String?

  // 内容文本
  content     String

  // 下一个节点ID (线性推进)
  nextNodeId  String?

  // 选项 JSON: [{text, nextNodeId, conditions?, effects?}]
  choices     String?

  // 条件 JSON: [{type, key, operator, value}]
  conditions  String?

  // 效果 JSON: [{type, target, value}]
  effects     String?

  // 战斗相关 (battle类型)
  enemyIds    String?      // 敌人ID列表 JSON
  battleRewards String?    // 战斗奖励 JSON

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([chapterId, order])
}

enum StoryNodeType {
  NARRATION   // 旁白
  DIALOGUE    // 对话
  CHOICE      // 选择
  BATTLE      // 战斗
  REWARD      // 奖励
}

// ==================== 玩家剧情进度 ====================

model PlayerStoryProgress {
  id               String   @id @default(uuid())
  playerId         String   @unique

  currentChapterId String?
  currentNodeId    String?

  // 已完成章节 JSON: ["chapter_1", "chapter_2"]
  completedChapters String  @default("[]")

  // 剧情标记 JSON: {flag1: true, flag2: "value"}
  flags            String   @default("{}")

  updatedAt        DateTime @updatedAt
}

// ==================== 任务系统 ====================

model QuestTemplate {
  id          String      @id @default(uuid())
  questId     String      @unique

  name        String
  description String
  type        QuestType

  // 任务目标 JSON: [{type, target, amount, description}]
  objectives  String

  // 奖励 JSON: [{type, itemId?, value?}]
  rewards     String

  // 解锁条件 JSON: [{type, value}]
  unlockConditions String?

  // 前置任务ID
  prerequisiteQuestId String?

  // 关联章节
  chapterId   String?

  // 是否可重复
  repeatable  Boolean     @default(false)
  repeatLimit Int?        // 重复次数限制

  // 时间限制 (秒)
  timeLimit   Int?

  // 推荐境界
  recommendedRealm String?

  order       Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([type, isActive])
  @@index([chapterId])
}

enum QuestType {
  MAIN        // 主线任务
  SIDE        // 支线任务
  DAILY       // 日常任务
  WEEKLY      // 周常任务
  EVENT       // 活动任务
  ACHIEVEMENT // 成就
}

// ==================== 玩家任务进度 ====================

model PlayerQuest {
  id          String      @id @default(uuid())
  playerId    String
  questId     String      // 对应 QuestTemplate.questId

  status      QuestStatus @default(IN_PROGRESS)

  // 目标进度 JSON: [{objectiveIndex, current, target}]
  progress    String      @default("[]")

  // 完成次数 (可重复任务)
  completedCount Int      @default(0)

  acceptedAt  DateTime    @default(now())
  completedAt DateTime?

  @@unique([playerId, questId])
  @@index([playerId, status])
}

enum QuestStatus {
  IN_PROGRESS
  COMPLETED
  CLAIMED     // 已领取奖励
  FAILED
}

// ==================== 敌人模板 ====================

model EnemyTemplate {
  id          String      @id @default(uuid())
  enemyId     String      @unique

  name        String
  description String?
  type        EnemyType

  level       Int         @default(1)

  // 属性倍率
  hpMultiplier      Float   @default(1.0)
  attackMultiplier  Float   @default(1.0)
  defenseMultiplier Float   @default(1.0)
  speedMultiplier   Float   @default(1.0)

  // 技能数据 JSON (完整技能对象数组)
  skills      String      @default("[]")

  // 掉落表 JSON: [{itemId, chance, quantity}]
  dropTable   String?

  // 奖励
  expReward         Int     @default(10)
  spiritStoneReward Int     @default(0)

  // 元素属性
  element     String?

  iconId      String?

  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([type])
  @@index([level])
}

enum EnemyType {
  NORMAL      // 普通怪
  ELITE       // 精英怪
  BOSS        // BOSS
  WORLD_BOSS  // 世界BOSS
}

// ==================== 副本系统 ====================

model DungeonTemplate {
  id          String   @id @default(uuid())
  dungeonId   String   @unique

  name        String
  description String?
  type        String   // story, daily, weekly, event

  // 关联章节
  chapterId   String?

  // 层数/关卡配置 JSON: [{level, enemyIds, rewards}]
  stages      String

  // 入场条件 JSON
  requirements String?

  // 消耗 (体力等)
  energyCost  Int      @default(10)

  // 每日次数限制
  dailyLimit  Int?

  // 推荐战力
  recommendedPower Int?

  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, isActive])
}

// ==================== 技能模板 ====================

model SkillTemplate {
  id          String    @id @default(uuid())
  skillId     String    @unique

  name        String
  description String
  type        SkillType

  // 元素属性
  element     String?

  // 消耗
  mpCost      Int       @default(0)
  cooldown    Int       @default(0) // 回合数

  // 伤害倍率
  damageMultiplier Float @default(1.0)
  hitCount    Int       @default(1)
  targetType  String    @default("single") // single, all, self, random

  // 效果 JSON: [{type, value, duration?, statusType?, chance?}]
  effects     String?

  // 学习条件 JSON
  requirements String?

  iconId      String?

  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type, element])
}

enum SkillType {
  ATTACK
  DEFENSE
  SUPPORT
  PASSIVE
  ULTIMATE
}

// ==================== 功法模板 ====================

model TechniqueTemplate {
  id          String   @id @default(uuid())
  techniqueId String   @unique

  name        String
  description String
  grade       String   // mortal, yellow, profound, earth, heaven, immortal

  // 元素属性
  element     String?

  // 修炼速度加成 (百分比)
  cultivationBonus Int @default(0)

  // 附带技能ID列表 JSON
  skillIds    String?

  // 学习条件 JSON
  requirements String?

  maxLevel    Int      @default(10)

  iconId      String?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([grade])
}

// ==================== 玩家功法 ====================

model PlayerTechnique {
  id           String   @id @default(uuid())
  playerId     String
  techniqueId  String

  level        Int      @default(1)
  proficiency  Int      @default(0) // 熟练度
  isActive     Boolean  @default(false)

  learnedAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([playerId, techniqueId])
  @@index([playerId])
}

// ==================== 玩家技能 ====================

model PlayerSkill {
  id        String   @id @default(uuid())
  playerId  String
  skillId   String

  level     Int      @default(1)

  learnedAt DateTime @default(now())

  @@unique([playerId, skillId])
  @@index([playerId])
}

// ==================== 炼丹系统 ====================

model AlchemyRecipe {
  id          String   @id @default(uuid())
  recipeId    String   @unique

  name        String
  description String?
  level       Int      @default(1)
  difficulty  Float    @default(1.0)

  // 所需材料 JSON: [{itemId, quantity}]
  materials   String

  // 产出物品
  resultItemId String
  resultQuantity Int  @default(1)

  // 成功率基础值
  baseSuccessRate Float @default(0.8)

  // 需要的丹炉等级
  requiredCauldronLevel Int @default(0)

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([level])
}

model AlchemyCauldron {
  id          String   @id @default(uuid())
  cauldronId  String   @unique

  name        String
  description String?
  level       Int      @default(1)
  quality     String   @default("common")

  // 加成效果 JSON: {successRateBonus, qualityBonus, speedBonus}
  bonus       String?

  // 获取方式
  obtainMethod String?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== 境界配置 ====================

model RealmConfig {
  id          String   @id @default(uuid())
  realmId     String   @unique

  name        String
  displayName String
  order       Int      // 排序序号

  // 阶段配置 JSON: [{stage, displayName, cultivationNeeded, attributes}]
  stages      String

  // 突破条件 JSON
  breakthroughConditions String?

  // 属性加成 JSON
  attributeBonuses String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

// ==================== 出身/灵根配置 ====================

model OriginConfig {
  id          String   @id @default(uuid())
  originId    String   @unique

  name        String
  description String?

  // 初始属性加成 JSON
  bonuses     String?

  // 起始物品 JSON: [{itemId, quantity}]
  startItems  String?

  // 起始剧情
  startStoryId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SpiritRootConfig {
  id          String   @id @default(uuid())
  rootId      String   @unique

  name        String
  description String?
  quality     String   // ordinary, excellent, heavenly

  // 元素列表 JSON: ["metal", "wood", ...]
  elements    String

  // 属性加成 JSON
  bonuses     String?

  // 修炼速度加成
  cultivationBonus Float @default(1.0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== 秘境系统 ====================

model RoguelikeDungeon {
  id          String   @id @default(uuid())
  dungeonId   String   @unique

  name        String
  description String?
  difficulty  Int      @default(1)
  maxFloors   Int      @default(10)

  // 完整配置 JSON
  config      String

  // 解锁条件 JSON
  unlockConditions String?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([difficulty])
}

model RoguelikeTalent {
  id          String   @id @default(uuid())
  talentId    String   @unique

  name        String
  description String?
  tier        Int      @default(1)

  // 效果 JSON: [{type, value, ...}]
  effects     String

  // 互斥天赋 JSON
  exclusiveWith String?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tier])
}

// ==================== 弟子派遣任务 ====================

model ExpeditionTemplate {
  id               String   @id @default(uuid())
  expeditionId     String   @unique

  name             String
  description      String?
  type             String   // gather, explore, hunt, special

  minLevel         Int      @default(1)
  minDiscipleCount Int      @default(1)
  maxDiscipleCount Int      @default(3)
  duration         Int      // 秒

  // 基础奖励 JSON: [{type, itemId?, quantity, chance}]
  baseRewards      String

  // 额外奖励 JSON
  bonusRewards     String?

  dangerLevel      Int      @default(1)
  injuryChance     Float    @default(0.05)

  // 特殊要求
  requiredTalent   String?
  minTalentValue   Int?

  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([type])
  @@index([minLevel])
}
